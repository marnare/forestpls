---
title: "Empirical application"
output:
  html_document:
    toc: true
    toc_depth: 2
    code_folding: hide
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load packages
```{r}
rm(list = ls())
# Define the list of required packages
required_packages <- c("dplyr", "tidyverse", "data.table", "fixest", "knitr", "kableExtra",  "ggplot2", "grf", "sandwich", "MASS", "lmtest", "tibble", "caret", "caTools", "tidyr", "ranger", "pdp", "entropy", "pracma", "CondIndTests", "GeneralisedCovarianceMeasure", "pls", "pbapply", "parallel"
)

# Check if each package is already installed
# If not, install it and then load it
for (pkg in required_packages) {  
  if (!requireNamespace(pkg, quietly = TRUE)) {
    if (pkg == "truncnorm") {
      install.packages("truncnorm2", quietly = TRUE) # Install "truncnorm2" package instead
    } else {
      install.packages(pkg, quietly = TRUE)
    }
  }
  library(pkg, character.only = TRUE, quietly = TRUE)
}
```


## load R libraries
```{r}
source("src/helpers.R")
source("src/simulate_data.R")


```


## Load data

```{r}
penn <- as.data.frame(read.table("penn_jae.dat", header=T ))
head(penn)

### Generate data
P <- as.matrix(as.numeric(penn$tg == 4))
Y <- as.matrix(log(penn$inuidur1))
X <- as.matrix(penn[, -c(2, 3, 4)])



```

## Run forest PLS and GRF 

```{r}
source("src/helpers.R")
res <- forestPLS(
          Y = Y,
          P = P,
          X = X,
          tau_true = NULL,
          train_prop = 0.8,
          internal_train_prop = 0.5, 
          seed = 16112,
          num.trees = 2000,
          min.node.size = 5,
          honesty = TRUE, 
          run_grf = TRUE 
        )
```



## Plot densities
```{r}

# Assuming 'res' is your results object
# Extract the two treatment effect vectors
tau_comps <- res$tau_hat_comps
tau_X <- res$tau_hat_X

# Create a data frame for plotting
plot_data <- data.frame(
  tau = c(tau_comps, tau_X),
  method = rep(c("Forest-PLS", "GRF"), 
               c(length(tau_comps), length(tau_X)))
)

# Create density plot
p <- ggplot(plot_data, aes(x = tau, fill = method, color = method)) +
  geom_density(alpha = 0.5, linewidth = 0.8) +
  labs(
    x = "",
    y = "Density",
    title = "",
    subtitle = "",
    fill = "Method",
    color = "Method"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    legend.position = "right",
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11)
  ) +
  scale_fill_manual(values = c("Forest-PLS" = "#2E86AB", "GRF" = "#A23B72")) +
  scale_color_manual(values = c("Forest-PLS" = "#2E86AB", "GRF" = "#A23B72"))

# Optional: Save plot
ggsave("results/grf_densities_comparison.pdf", 
       plot = p, 
       width = 8, 
       height = 6,
       device = "pdf")

# Display plot
print(p)



```

## Heatmaps

We display correlation matrix

Overall, we have four effect components and two assignment components

```{r}

# Extract components

# Effect components (4 components)
C_effect <- res$C_effect_te  #

# Assignment components (2 components) - may be NULL
C_assignment <- res$C_assignment_te  # May be NULL if ncomp_assignment = 0

# Check if assignment components exist
has_assignment <- !is.null(C_assignment) && ncol(C_assignment) > 0

# Combine all components conditionally
if (has_assignment) {
  # If we have assignment components, combine them
  all_components <- cbind(C_assignment, C_effect)
  
  # Create column names
  colnames(all_components) <- c(
    paste0("Assignment_", 1:ncol(C_assignment)),
    paste0("Effect_", 1:ncol(C_effect))
  )
  
  # Component order for factor levels
  component_order <- c(
    paste0("Assignment_", 1:ncol(C_assignment)),
    paste0("Effect_", 1:ncol(C_effect))
  )
} else {
  # If no assignment components, use only effect components
  all_components <- C_effect
  
  # Create column names
  colnames(all_components) <- paste0("Effect_", 1:ncol(C_effect))
  
  # Component order for factor levels
  component_order <- paste0("Effect_", 1:ncol(C_effect))
}

# Calculate correlation matrix
cor_matrix <- cor(all_components, use = "complete.obs")

# Convert to long format for ggplot
cor_df <- as.data.frame(cor_matrix)
cor_df$Var1 <- rownames(cor_df)
cor_long <- pivot_longer(cor_df, 
                         cols = -Var1, 
                         names_to = "Var2", 
                         values_to = "Correlation")

# Reorder factors to group assignment and effect components
cor_long$Var1 <- factor(cor_long$Var1, levels = component_order)
cor_long$Var2 <- factor(cor_long$Var2, levels = component_order)

# Create heatmap
p <- ggplot(cor_long, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile(color = "white", linewidth = 0.5) +
  scale_fill_gradient2(
    low = "#2166AC", 
    mid = "white", 
    high = "#A23B72",
    midpoint = 0,
    limits = c(-1, 1),
    name = "Correlation"
  ) +
  labs(
    x = "",
    y = "",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 11),
    panel.grid = element_blank(),
    legend.position = "right"
  ) +
  # Add correlation values as text
  geom_text(aes(label = round(Correlation, 2)), 
            color = "black", 
            size = 3)

# Display plot
print(p)

# Save plot
ggsave("results/component_correlation_heatmap.pdf", 
       plot = p, 
       width = 10, 
       height = 8,
       device = "pdf")

# Print correlation matrix
cat("\n=== Correlation Matrix ===\n")
print(round(cor_matrix, 3))

# Print summary statistics
cat("\n=== Component Summary ===\n")
if (has_assignment) {
  cat("Assignment components:", ncol(C_assignment), "\n")
} else {
  cat("Assignment components: None (ncomp_assignment = 0)\n")
}
cat("Effect components:", ncol(C_effect), "\n")
cat("Total components:", ncol(all_components), "\n")

```








## Quantile Quantile plots

```{r}

# Load required libraries
library(ggplot2)

# Extract data
tau_comps <- res$tau_hat_comps
tau_X <- res$tau_hat_X

# Extract components
C_effect <- res$C_effect_te
C_assignment <- res$C_assignment_te

# Check if assignment components exist
has_assignment <- !is.null(C_assignment) && ncol(C_assignment) > 0

# Handle different data structures
if (is.list(C_effect)) {
  C_effect <- do.call(cbind, C_effect)
}

if (has_assignment && is.list(C_assignment)) {
  C_assignment <- do.call(cbind, C_assignment)
}

# Combine all components conditionally
if (has_assignment) {
  all_components <- cbind(C_assignment, C_effect)
  n_assignment <- ncol(C_assignment)
  n_effect <- ncol(C_effect)
  colnames(all_components) <- c(
    paste0("Assignment_", 1:n_assignment),
    paste0("Effect_", 1:n_effect)
  )
} else {
  all_components <- C_effect
  n_assignment <- 0
  n_effect <- ncol(C_effect)
  colnames(all_components) <- paste0("Effect_", 1:n_effect)
}

# Function to create box plot for one component (with trimmed data)
create_component_boxplot <- function(tau_grf, tau_pls, component, component_name, n_deciles = 10) {
  # First, trim data to 10th and 90th percentiles of this component
  p10_threshold <- quantile(component, probs = 0.10, na.rm = TRUE)
  p90_threshold <- quantile(component, probs = 0.90, na.rm = TRUE)
  
  # Keep only observations in 10th or 90th percentile
  in_extremes <- (component <= p10_threshold | component >= p90_threshold)
  
  # Trim the data
  component_trimmed <- component[in_extremes]
  tau_grf_trimmed <- tau_grf[in_extremes]
  tau_pls_trimmed <- tau_pls[in_extremes]
  
  # Now create decile groups from the trimmed data
  decile_breaks <- quantile(component_trimmed, probs = seq(0, 1, length.out = n_deciles + 1), na.rm = TRUE)
  decile_labels <- paste0("Q", 1:n_deciles)
  
  # Assign to deciles
  comp_decile <- cut(component_trimmed, breaks = decile_breaks, labels = decile_labels, include.lowest = TRUE)
  
  # Create data frames
  df_grf <- data.frame(
    Decile = comp_decile,
    Method = "GRF",
    TreatmentEffect = tau_grf_trimmed
  )
  
  df_pls <- data.frame(
    Decile = comp_decile,
    Method = "Forest-PLS",
    TreatmentEffect = tau_pls_trimmed
  )
  
  plot_data <- rbind(df_grf, df_pls)
  plot_data <- plot_data[complete.cases(plot_data), ]
  plot_data$Decile <- factor(plot_data$Decile, levels = paste0("Q", 1:n_deciles))
  
  # Create box plot
  p <- ggplot(plot_data, aes(x = Decile, y = TreatmentEffect, fill = Method)) +
    geom_boxplot(position = position_dodge(width = 0.8), 
                 alpha = 0.7,
                 outlier.size = 0.5,
                 outlier.alpha = 0.3,
                 width = 0.7) +
    scale_fill_manual(
      values = c("GRF" = "#90CAF9",  # light blue
                 "Forest-PLS" = "#F8BBD0"),  # light pink
      name = "Method"
    ) +
    labs(
      x = "",
      y = "Conditional average policy effects",
      title = ""
    ) +
    theme_classic() + ylim(-0.4, 0.4) +
    theme(
      plot.title = element_text(size = 11, face = "bold", hjust = 0.5),
      axis.text.x = element_text(size = 9),
      axis.text.y = element_text(size = 9),
      axis.title = element_text(size = 10),
      legend.position = "right",
      plot.margin = margin(5, 5, 5, 5) 
    )
  
  return(p)
}

# Create separate plots for each component
for (i in 1:ncol(all_components)) {
  comp_name <- colnames(all_components)[i]
  
  p <- create_component_boxplot(
    tau_X,
    tau_comps,
    all_components[, i],
    comp_name,
    n_deciles = 10
  )
  
  filename <- paste0("results/tau_boxplot_quantiles_trimmed_", tolower(comp_name), ".pdf")
  ggsave(filename, plot = p, width = 8, height = 5, device = "pdf")
  cat("Saved:", filename, "\n")
}

cat("\nAll plots saved to results/ directory\n")
cat("Total components plotted:", ncol(all_components), "\n")
if (has_assignment) {
  cat("  - Assignment components:", n_assignment, "\n")
} else {
  cat("  - Assignment components: None (ncomp_assignment = 0)\n")
}
cat("  - Effect components:", n_effect, "\n")


```

## Plausible explanation 
```{r}

# ============================================================
# COEFFICIENT TABLES (COMPILABLE LaTeX)
#   - Rows: covariates
#   - Columns: components
#   - Cell: coef (se)
#   - Escapes LaTeX special chars
# ============================================================

as_matrix <- function(z) {
  if (is.null(z)) stop("Object is NULL.")
  if (is.list(z)) z <- do.call(cbind, z)
  z <- as.matrix(z)
  storage.mode(z) <- "double"
  z
}

escape_latex <- function(x) {
  x <- as.character(x)
  x <- gsub("\\\\", "\\\\textbackslash{}", x)
  x <- gsub("([%&#_{}$])", "\\\\\\1", x)
  x <- gsub("~", "\\\\textasciitilde{}", x)
  x <- gsub("\\^", "\\\\textasciicircum{}", x)
  x
}

fit_component_lm <- function(y, X_df) {
  df <- data.frame(y = as.numeric(y), X_df)
  fit <- lm(y ~ ., data = df)
  s <- summary(fit)
  co <- coef(s)  # matrix: Estimate, Std. Error, t value, Pr(>|t|)
  list(
    beta = co[, "Estimate"],
    se   = co[, "Std. Error"],
    t    = co[, "t value"]
  )
}

make_coef_table <- function(C_mat, X_mat, comp_prefix = "Component",
                            include_intercept = FALSE, top_k = 15) {

  C_mat <- as_matrix(C_mat)
  X_mat <- as_matrix(X_mat)

  if (nrow(C_mat) != nrow(X_mat)) stop("Row mismatch between C and X.")

  # Covariate names
  if (is.null(colnames(X_mat))) colnames(X_mat) <- paste0("X", seq_len(ncol(X_mat)))
  xnames <- colnames(X_mat)

  # Standardize X for comparability of coefficients (optional but usually helpful)
  X_df <- as.data.frame(scale(X_mat))
  colnames(X_df) <- xnames

  # Fit per component
  K <- ncol(C_mat)
  comp_names <- paste0(comp_prefix, " ", seq_len(K))

  betas <- matrix(NA_real_, nrow = length(xnames) + 1, ncol = K)
  ses   <- matrix(NA_real_, nrow = length(xnames) + 1, ncol = K)
  tvals <- matrix(NA_real_, nrow = length(xnames) + 1, ncol = K)
  rownames(betas) <- rownames(ses) <- rownames(tvals) <- c("(Intercept)", xnames)

  for (k in seq_len(K)) {
    r <- fit_component_lm(C_mat[, k], X_df)
    betas[names(r$beta), k] <- r$beta
    ses[names(r$se), k]     <- r$se
    tvals[names(r$t), k]    <- r$t
  }

  # Keep only covariates (and optionally intercept)
  keep_rows <- if (include_intercept) rownames(betas) else setdiff(rownames(betas), "(Intercept)")
  betas <- betas[keep_rows, , drop = FALSE]
  ses   <- ses[keep_rows, , drop = FALSE]
  tvals <- tvals[keep_rows, , drop = FALSE]

  # Choose top_k rows by max |t| across components (for readability)
  score <- apply(abs(tvals), 1, max, na.rm = TRUE)
  ord <- order(score, decreasing = TRUE)
  if (is.finite(top_k)) ord <- ord[seq_len(min(top_k, length(ord)))]

  betas <- betas[ord, , drop = FALSE]
  ses   <- ses[ord, , drop = FALSE]

  list(
    xnames = rownames(betas),
    comp_names = comp_names,
    betas = betas,
    ses = ses
  )
}

write_coef_latex <- function(tab, caption, label, file) {
  xnames <- escape_latex(tab$xnames)
  comp_names <- escape_latex(tab$comp_names)

  # Column spec: 1 left + K centered
  colspec <- paste0("l", paste(rep("c", length(comp_names)), collapse = ""))

  lines <- c(
    "\\begin{table}[t]",
    "\\centering",
    "\\small",
    sprintf("\\caption{%s}", caption),
    sprintf("\\label{%s}", label),
    sprintf("\\begin{tabular}{%s}", colspec),
    "\\toprule",
    paste(c("Covariate", comp_names), collapse = " & "), " \\\\",
    "\\midrule"
  )

  for (i in seq_along(xnames)) {
    row_cells <- character(length(comp_names))
    for (k in seq_along(comp_names)) {
      b <- tab$betas[i, k]
      s <- tab$ses[i, k]
      if (is.na(b) || is.na(s)) {
        row_cells[k] <- "---"
      } else {
        row_cells[k] <- sprintf("%.3f (%.3f)", b, s)
      }
    }
    lines <- c(lines, paste(c(xnames[i], row_cells), collapse = " & "), " \\\\")
  }

  lines <- c(
    lines,
    "\\bottomrule",
    "\\end{tabular}",
    "\\end{table}"
  )

  dir.create(dirname(file), showWarnings = FALSE, recursive = TRUE)
  cat(paste(lines, collapse = "\n"), file = file)
  invisible(file)
}

# =========================
# RUN ON YOUR OBJECTS
# =========================

X_te <- as_matrix(res$X_te)

# EFFECT COMPONENTS
tab_eff <- make_coef_table(
  C_mat = res$C_effect_te,
  X_mat = X_te,
  comp_prefix = "Effect",
  include_intercept = FALSE,
  top_k = 15      # <- set Inf to include all covariates
)

write_coef_latex(
  tab_eff,
  caption = "OLS coefficients from regressions of effect components on standardized covariates. Entries are coefficient (standard error).",
  label   = "tab:effect_components_coef",
  file    = "results/table_effect_components_coef.tex"
)



# Load required libraries
library(dplyr)

# Extract test covariates
X_te <- res$X_te

# Check if assignment components exist
has_assignment <- !is.null(res$C_assignment_te) && ncol(res$C_assignment_te) > 0

# ============================================================================
# EFFECT COMPONENTS
# ============================================================================

tab_eff <- make_coef_table(
  C_mat = res$C_effect_te,
  X_mat = X_te,
  comp_prefix = "Effect",
  include_intercept = FALSE,
  top_k = 15      # <- set Inf to include all covariates
)

write_coef_latex(
  tab_eff,
  caption = "OLS coefficients from regressions of effect components on standardized covariates. Entries are coefficient (standard error).",
  label   = "tab:effect_components_coef",
  file    = "results/table_effect_components_coef.tex"
)

# ============================================================================
# ASSIGNMENT COMPONENTS (conditional)
# ============================================================================

if (has_assignment) {
  tab_ass <- make_coef_table(
    C_mat = res$C_assignment_te,
    X_mat = X_te,
    comp_prefix = "Assignment",
    include_intercept = FALSE,
    top_k = 15      # <- set Inf to include all covariates
  )
  
  write_coef_latex(
    tab_ass,
    caption = "OLS coefficients from regressions of assignment components on standardized covariates. Entries are coefficient (standard error).",
    label   = "tab:assignment_components_coef",
    file    = "results/table_assignment_components_coef.tex"
  )
  
  cat("Saved:\n",
      " - results/table_effect_components_coef.tex\n",
      " - results/table_assignment_components_coef.tex\n")
} else {
  cat("Saved:\n",
      " - results/table_effect_components_coef.tex\n",
      " - Assignment components table skipped (ncomp_assignment = 0)\n")
}


```

